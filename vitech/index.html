<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
    <style>
        input:focus {background: pink; color: blue;}
        button:focus {background: pink; color: blue;}
        .button {
            display: inline-block;
            padding: 15px 30px;
            font-size: 30px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            outline: none;
            color: #fff;
            background-color: purple;
            border: none;
            border-radius: 15px;
            box-shadow: 0 9px #999;
        }
        .button:hover {background-color: #58257b}
        .button:active {
            background-color: #58257b;
            box-shadow: 0 5px #666;
            transform: translateY(4px);
        }
        #reader {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding-top: 20px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.0.3/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="field is-grouped">
        <p class="control">
            <button class="button is-info" onclick="ChangeName()">Tên</button>
        </p>
        <p class="control">
            <button class="button is-success" onclick="ChangeWS()">Nội dung</button>
        </p>
        <p class="control">
            <button class="button is-warning" onclick="ChangeCode()">QR-Code</button>
        </p>
    </div>

    <input class="input is-normal input-name is-fullwidth" placeholder="Người kiểm" id="Name">
    <input class="input is-normal input-ws is-fullwidth" placeholder="Nội dung" id="WS">
    <input class="input is-rounded is-large input-code is-fullwidth" placeholder="Code" id="code">
    <input class="input is-normal is-warning input-Number" placeholder="Tình trạng" id="Number-code">
    

    <button class="button is-danger is-fullwidth" onclick="sendData()">Save</button>
    <button class="button is-primary is-fullwidth" onclick="showTempData()">Xem Danh Sách</button>
    
    <div id="temp-list" style="display:none; margin-top: 20px;">
        <h3 class="title is-4">Dữ Liệu Đã Lưu</h3>
        <div id="list-content"></div>
    </div>

    <!-- Camera QR Code Reader -->
    <div id="reader"></div>

    <script>
        let html5QrCode;

        function ChangeName() {
            document.querySelector('.input-name').value = '';
            document.getElementById("Name").focus();
        }

        function ChangeWS() {
            document.querySelector('.input-ws').value = '';
            document.getElementById("WS").focus();
        }

        function ChangeCode() {
            document.querySelector('.input-code').value = '';
            document.getElementById("code").focus();
        }

        function IsEmpty() {
            if (document.querySelector('.input-ws').value === "") {
                alert("Hãy nhập nội dung công việc của bạn");
                return false;
            }
            return true;
        }

        function saveToLocalStorage(data) {
            let storedData = JSON.parse(localStorage.getItem('tempData')) || [];
            storedData.push(data);
            localStorage.setItem('tempData', JSON.stringify(storedData));
        }

        function showTempData() {
            const tempList = document.getElementById('temp-list');
            const listContent = document.getElementById('list-content');
            tempList.style.display = tempList.style.display === 'none' ? 'block' : 'none';

            const storedData = JSON.parse(localStorage.getItem('tempData')) || [];
            listContent.innerHTML = '';
            if (storedData.length === 0) {
                listContent.innerHTML = '<p>Không có dữ liệu nào trong bộ nhớ tạm.</p>';
            } else {
                const ul = document.createElement('ul');
                storedData.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${index + 1}:</strong> Tên: ${item.name}, Bộ phận: ${item.ws}, 
                                    Số lượng: ${item.Number}, Mã hàng: ${item.class}, 
                                    Tình trạng: ${item.NG}`;
                    ul.appendChild(li);
                });
                listContent.appendChild(ul);
            }
        }

        function sendData() {
            if (!IsEmpty()) return;
            if (document.querySelector('.input-code').value === "") {
                alert("Hãy nhập mã hàng hoặc quét mã QR.");
                return false;
            }

            const data = {
                name: document.querySelector('.input-name').value,
                ws: document.querySelector('.input-ws').value,
                Number: document.querySelector('.input-Number').value,
             
                class: document.querySelector('.input-code').value
            };

            const API_URL = "https://script.google.com/macros/s/AKfycbzwz-HHJd_QSYhV-uLoAtMOc413a1BbBUFBKiu9ge1n_vF1BHF2eM43PoAIOF1pcH8E_g/exec";
            const options = {
                method: 'POST',
                contentType: 'application/json',
                body: JSON.stringify(data)
            };

            fetch(API_URL, options)
                .then(response => response.json())
                .then(res => {
                    console.log(res);
                    document.querySelector('.input-code').value = '';
                    document.querySelector('.input-Number').value = '';
                   
                    document.getElementById("code").focus();
                    play();

                    saveToLocalStorage(data);

                    startScan();
                });
        }

        function play() {
            var audio = new Audio('https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/beep.mp3');
            audio.play();
        }

        function onScanSuccess(qrCodeMessage) {
            document.querySelector('.input-code').value = qrCodeMessage;
            html5QrCode.stop();
        }

        function startScan() {
            document.getElementById('reader').innerHTML = '';
            html5QrCode = new Html5Qrcode('reader');
            html5QrCode.start({ facingMode: "environment" }, { fps: 5, qrbox: 450 }, onScanSuccess);
        }

        startScan();
    </script>
</body>
</html>
